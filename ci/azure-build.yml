parameters:
- name: zolaVersion
  default: '0.18.0'
  type: string

jobs:

- job: build
  pool:
    vmImage: ubuntu-latest

  variables:
    TOOLCHAIN: stable

  steps:

  - checkout: self
    fetchDepth: 0

  - bash: |
      curl -fsSL \
        'https://github.com/getzola/zola/releases/download/v${{ parameters.zolaVersion }}/zola-v${{ parameters.zolaVersion }}-x86_64-unknown-linux-gnu.tar.gz' \
      | tar zx
    displayName: "Install Zola ${{ parameters.zolaVersion }}"

  - bash: |
      set -e
      rustup set profile minimal
      rustup component remove --toolchain=$TOOLCHAIN rust-docs || echo "already removed"
      rustup update --no-self-update $TOOLCHAIN
      rustup default $TOOLCHAIN
      # Log versions
      set -ex
      rustup -V
      rustc -Vv
      cargo -V
    displayName: Set up Rust

  - bash: cargo build --release
    displayName: "Build deploytool"

  - bash: cargo run --release -- apply
    displayName: "deploytool apply"

  - bash: ./zola build -o $(build.artifactStagingDirectory)/website
    displayName: "Build site with Zola"

  - task: PublishPipelineArtifact@0
    displayName: Store built site as pipeline artifact
    inputs:
      artifactName: website
      targetPath: $(build.artifactStagingDirectory)/website

  # At some point we might add post-build analytics steps here

  - bash: |
      set -xeuo pipefail
      git add content
      cargo run --release -- commit
      git show
    displayName: "deploytool commit"

  - bash: |
      set -xeuo pipefail
      artifact_dir="$(build.artifactStagingDirectory)/git-deploy"
      mkdir -p "$artifact_dir"
      git bundle create "$artifact_dir/deploy.bundle" origin/master..HEAD
    displayName: "Bundle deploy commit"

  - task: PublishPipelineArtifact@1
    displayName: Publish git bundle artifact
    inputs:
      artifactName: git-deploy
      targetPath: $(build.artifactStagingDirectory)/git-deploy
